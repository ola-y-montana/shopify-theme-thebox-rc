<style>
/*===============================
  Newsletter Modal SCSS
===============================*/
.tbm_modal-container {
  display: none;
  width: 100%;
  height: 100%;
  position: fixed;
  background: rgba(0,0,0,0.6);
  z-index: 1000000;
  top: 0;
  left: 0;
      overflow-x: hidden!important;
    overflow-y: auto!important;
}
.tbm_modal {
  margin-top: 10%;
  position: fixed;
  left: 50%;
  top: 25%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 0px;
  text-align: center;
  display: table;
  width: 700px;
  border-radius: 17px;
  .tbm_modal-left-col, .tbm_modal-right-col {
    display: table-cell;
    padding: 50px 20px;
    vertical-align: middle;
  }
  .tbm_modal-left-col {
    width: 35%;
    display: block;
    background-size: cover;
    background-position: center;
  }
  .tbm_modal-right-col {
    width: 65%;
  }
  .tbm_modal-clear {
    clear: both;
  }
  h2 {
    font-size: 35px;
    font-weight: 800;
    margin: 0!important;
    line-height: 1.7;
    &::before {
      content: "";
      display: block;
      border-top: 3px solid #39b54a;
      width: 80px;
      margin: 10px auto;
    }
  }
  p {
    font-style: italic;
    font-family: times;
    font-size: 16px!important;
    margin-top: 0;
    margin-bottom: 40px;
  }
  input[type=email], 
  input[type=submit] {
    display: block!important;
    float: none!important;
    width: 60% !important;
    margin: 0 auto 10px!important;
    text-align: center;
    max-width: inherit !important;
  }
  input[type=email] {
    padding: 8px 25px;
    background: #fff;
    text-align: left !important;
    border: 2px solid #dedede;
    text-align: center;
  }
  input[type=submit] {
    padding: 12px 10px 12px;
    height: inherit !important;
    background: #39b54a;
    color: #fff;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 12px;
    border: 0;
  }
  span.tbm_modal-close {
    font-size: 12px!important;
    color: #888;
    text-decoration: underline;
    margin-top: 40px;
    display: block;
    cursor: pointer;
  }
}
.tbm_modal-clickable {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  z-index: -1;
  cursor: pointer;
}
  /*@media(min-width:500px){
  	.tbm_modal p {
    margin-bottom: 15px;
    line-height: 1.3;
    font-size: 14px!important;
  }
  }*/
@media(max-width:702px){
  .tbm_modal {
      margin-top: 10%;
  position: fixed;
  left: 50%;
  top: 43%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 0px;
  text-align: center;
  display: table;
  width: 700px;
    border-radius: 17px;}
  
    .tbm_modal-left-col, .tbm_modal-right-col {
    display: table-cell;
    padding: 0px 20px!important;
    vertical-align: middle;
  }
  
  p.tbm_modal-close {
    margin-left: 15%!important;
    font-size: 30px!important;
    padding-top: 20px;
    cursor: pointer;
}
  
  .col-3.text-center {
    margin-right: 20px!important;
    margin-left: 5px!important;
    margin-top: 20px;
    margin-bottom: 20px;
}
  .tbm_modal {
    width: 95%!important;
    
  }
  .tbm_modal h2 {
    font-size: 16px;
    font-weight: 100;
    margin: 0px 0 10px!important; 
    line-height: 1;
  }
  .tbm_modal-left-col, .tbm_modal-right-col {
    padding: 10px 20px;
  }
  .tbm_modal input[type=submit] {
    margin: 0;
    padding: 6px 0px 0px;
    font-size: 11px;
    line-height: 2!important;
    height: auto!important;
    width: 100%!important;
    border: 0;
    border-radius: 0;
  }
  .tbm_modal input[type=email] {
    padding: 5px;
    height: inherit;
    margin-bottom: 6px!important;
    line-height: 1;
    border: 0;
    border-radius: 0;
  }
  .tbm_modal span.tbm_modal-close {
    margin: 0;
  }
  .tbm_modal p {
    margin-bottom: 15px;
    line-height: 1.3;
    font-size: 10px!important;
}
  
  
  .tbm_modal form {
    margin-bottom: 10px;
  }
  .tbm_modal-closeable {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    display: block;
    z-index: 9999;
  }
    .title-stock {
    text-align: left;
    padding-left: 0!important;
    margin-top: 20px;
    font-size: 20px;
    font-weight: bolder;
    padding-bottom: 17px;
}
    .stock-email-phone {
    display: block!important;
     }
 
}

    .stock-email-phone {
    text-align: left;
    font-weight: 400;
    display: flex;
    }
 .tbm_modal {
    width: 55%;
   max-width: 700px;
  }
  
.items-stock-modal {
    display: flex;
}
  .col-3.text-center {
    margin-right: 30px;
    margin-left: 30px;
    margin-top: 20px;
    margin-bottom: 20px;
}
  .col-9 {
    margin-bottom: 20px;
    margin-top: 20px;
}
  .stock-address1 {
    font-size: 18px;
    font-weight: 600;
    text-transform: capitalize;
    text-align: left;
}
  .stock-address2 {
    font-size: 12px;
    font-weight: 500;
    color: #000;
    text-transform: capitalize;
    text-align: left;
}
  .stock-disponible {
    border-radius: 56%;
    height: 40px;
    text-align: center;
    justify-content: center;
    display: flex;
    width: 40px;
    margin: 0 auto;
    padding-top: 8px;
    background: #000;
    color: #fff;
}
  p.text-available {
    font-weight: 500;
    color: #000;
}
  
  input#stock-prom {
    width: 100%;
    outline: none!important;
}

  .title-stock {
    width: 90%;
    text-align: left;
    padding-left: 20px;
    margin-top: 20px;
    font-size: 20px;
    font-weight: bolder;
    padding-bottom: 17px;
}
  
.search-row {
    width: 91%;
}
.col-1 {
    flex: 0 0 auto;
    width: 9%;
}

.col-1.text-center.d-flex.align-items-center {
    margin-top: 8px;
    margin-bottom: 0px;
}

.Search-group {
    display: flex;
    border: solid 1px;
}

.Search-group:focus,
.Search-group.focus {
    border: 1px solid #000;
    border-left: 0;
    border-right: 0px;
}
  
  .template-warning p {
    color: #e50000;
    font-weight: 600;
    font-size: 15px;
}
  .Modal-header {
    display: flex;
}
  p.tbm_modal-close {
    margin-left: 5%;
    margin-right: 20px;
    font-size: 30px!important;
    padding-bottom: 12px;
	cursor: pointer;
}
  .search-row input, .search-row textarea, .search-row select, .search-row .disclosure__toggle {
    border: 0px solid #cccccc00;
    background-color: #0000;
    color: #000;
    max-width: 100%;
    line-height: 1.5;
    border-radius: 2px;
}
  button#btn-modal-stock {
    background: #fff;
    color: #000;
    border: solid 1px #000;
}

#modalStock label {
  text-align: left;
}

#modalStock .controls > div {
  display: flex;
  column-gap: 6px;
  padding-bottom: 20px;
}

#modalStock .controls .sizes-option-wrapper {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    position: relative;
    -webkit-flex-wrap: wrap;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin-bottom: 10px;
}
#modalStock .controls .size-option-button {
    outline: none !important;
    width: auto;
    min-width: 38px;
    height: 35px;
    line-height: 16px;
    padding: 9px 10px;
    box-sizing: border-box;
    font-size: 13px;
    width: auto;
    min-width: 44px;
    height: 41px;
    line-height: 19px;
    font-family: inherit;
    font-weight: bold;
    border-radius: 3px;
    margin: 0 8px 8px 0;
    color: #010101; /* #888 */
    border: 1.1px solid #e6e6e6;
    background-color: #f9f9f9;
}
#modalStock .controls .size-option-button.selected {
    color: #064888;
    border-color: #064888;
    background-color: #f9fcf3;
}
#modalStock .controls .size-option-button.unavailable {
    position: relative;
    color: #cccccc;
    border: 1px solid #e6e6e6;
    background-color: inherit;
    background: linear-gradient( to bottom right, #fff calc(50% - 1px), #e6e6e6, #fff calc(50% + 1px) );
}

#modalStock .loader-wrapper {
  padding-top: 20px;
  margin-bottom: 20px;
  display: inline-block;
}

@media all and (min-width: 768px) {
  .Search-group{
    border-right: 0;
    border-left: 0;
  }
  #modalStock label {
    padding: 0 20px;
  }
  #modalStock .controls > div {
    padding: 0 20px;
  }
}

</style>

<!--  Modal stock  -->
<div class="tbm_modal-container" >
  <div id="modalStock" class="tbm_modal">
    <div class="tbm_modal-right-col">
      <!--FORM-->
      <div class="Modal-header">
        <div class="title-stock">Stock disponible en tienda</div>
        <p class="tbm_modal-close">&times</p>
      </div>
      <label>Elige una talla:</label>
      <div class="controls"></div>
      <div id="mc_embed_signup">
        <div class="Search-group">
          <div class="col-1 text-center d-flex align-items-center">
            <img src="https://d13xymm0hzzbsd.cloudfront.net/1/20201109/16049584603899.svg">
          </div>
          <div class="search-row">
            <input type="search" id="stock-prom" placeholder="Buscar tienda…"></input>
        </div>
      </div>

      <!--<div class="row nd-pr__storeAvailabilityModal-search">
        <div class="col-1 text-center d-flex align-items-center">
        <img src="https://d13xymm0hzzbsd.cloudfront.net/1/20201109/16049584603899.svg">
        </div>
        <div class="col-10">
        <input id="store-availability-input-search" type="text" placeholder="Buscar tienda…">
        </div>
        </div>-->

      <div id="modal-content" style="max-height: 300px;overflow: auto;padding-top: 20px;padding-bottom: 20px;"></div>

      <span class="hide loader-wrapper">
        {% include 'icon-spinner' %}
      </span>

    </div>  
    <!--FORM ENDS-->

    <span class="tbm_modal-close">{{settings.tbm_cookie-modal-close-message}}</span>
  </div>
  <div class="tbm_modal-clear"></div>
</div>
<div class="tbm_modal-clickable"></div>
</div>
<!--  Modal stock end   -->

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
 function defer(method, validation) {
    if (validation()) {
      method();
    } else {
      setTimeout(function() { defer(method, validation) }, 50);
    }
 }
</script>
  
<script>
  defer(function(){
    $(document).ready(function(){
      const getSockbySku = async (url) => {

        let data = []

        try {
          const result = await axios({
            method: 'get',
            url,
            headers:{
              "S-API-AppKey": "OYM-1f7d052488bc42dc-b54a1a058e03810d",
              "S-API-AppToken": "4b505ce77166464b9b89ebc5398a63b89e7a98df92674c9c96ec2c84d6000109"
            }})

          data = result && result.data

        } catch(error) {
          console.log(error)
        }

        return data
      }  

      let data = null // se llena el getSockbySku()
      function getTemplate({disponible,storename, address1, storeEmail, phone1}){
        const stockDisponibleSeguridad = (Number(disponible) || 1)
        return `<div class="items-stock-modal">
              <div class="col-3 text-center">
              <div class="stock-disponible">${stockDisponibleSeguridad}</div>
              <p class="text-available"> Disponible(s)</p>
                </div>
              <div class="col-9">
              <div class="stock-address1">${storename.toLowerCase()}</div>
              <div class="stock-address2">${address1.toLowerCase()}</div>
              <div class="stock-email-phone">
              <div class="stock-phone"><b>Telf: </b>${phone1 && phone1.toLowerCase()}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
              <div class="stock-email"><b>Email: </b>${storeEmail && storeEmail.toLowerCase()}</div>
              </div>
              <div class="nd-pr__storeAvailabilityModal-store-text"></div>
                </div> 
              </div>`
      }

      function removeAccents(strAccents) {
        var strAccents = strAccents.split('');
        var strAccentsOut = new Array();
        var strAccentsLen = strAccents.length;
        var accents =    "ÀÁÂÃÄÅàáâãäåÒÓÔÕÕÖØòóôõöøÈÉÊËèéêëðÇçÐÌÍÎÏìíîïÙÚÛÜùúûüÑñŠšŸÿýŽž";
        var accentsOut = "AAAAAAaaaaaaOOOOOOOooooooEEEEeeeeeCcDIIIIiiiiUUUUuuuuNnSsYyyZz";
        for (var y = 0; y < strAccentsLen; y++) {
          if (accents.indexOf(strAccents[y]) != -1) {
            strAccentsOut[y] = accentsOut.substr(accents.indexOf(strAccents[y]), 1);
          } else
            strAccentsOut[y] = strAccents[y];
        }
        strAccentsOut = strAccentsOut.join('');
        return strAccentsOut;
      }

      function search(valueCurent) {
        let template = ''
        const isMatch = ({storename, currentSearch}) => removeAccents(storename.toLowerCase())
        .indexOf(removeAccents(currentSearch.toLowerCase()));
        const findAdress = data.find(e =>  isMatch({storename:e.storename, currentSearch:valueCurent}) > -1 );
        if(findAdress && findAdress.storename){

          data.forEach((value) => {  
            if (isMatch({storename:value.storename, currentSearch:valueCurent}) > -1) template += getTemplate(value)
              })

        } else if (valueCurent === '') { data.forEach((value) =>{ template += getTemplate(value)}) }

        else { template = `Lo sentimos, no pudimos encontrar nada para "${valueCurent}"`}

        return template
      }

      /* search del stock*/
      document.querySelector("#stock-prom").addEventListener("input",function (value) {
        const modaltContent = document.getElementById('modal-content')
        const valueSearch = value.target.value
        //console.log("valueSearch",valueSearch)
        const template = search(valueSearch)
        //console.log("template",template)
        modaltContent.innerHTML = template  
      })

      function messageErrorBySelectedSku(){
        const template = `<div class="template-warning" id="message-error-getSku"><p>Seleccione una talla</p></div>`
        
        if(!document.getElementById('message-error-getSku')) {
          $('div.product-form__item > div').parent().append(template)
        }

      }

      async function checkSkuStock(sku) {
          const $modal = $('#modalStock')
          const $loaderWrapper = $modal.find('.loader-wrapper')

          try {
            if (!sku) { return }
    
            const $modalContent = $modal.find('#modal-content')

            $modalContent.fadeOut()

            $loaderWrapper.removeClass('hide')
    
            let data = await getSockbySku(`https://oymbrands.com:3000/api/proxy/ecommerce/stock-by-sku/${sku}`)
  
            $('p').append(data);
  
            data = data.filter(s => (s.storeno !== 4 && s.storeno !== 54) && !(s.storename && s.storename.toUpperCase().indexOf('COOL BRANDS') > -1))
  
            let template = ''
            data.forEach((value) =>{
              const isCoolbrands = (value.storeno) === 4 || (value.storename && value.storename.toUpperCase().indexOf('COOL BRANDS') > -1)
              if (!isCoolbrands) { // exclude coolbrands
                template += getTemplate(value)
              }
            })
  
            if (!data.length) {
              template = 'Lo sentimos, este producto no se encuentra disponible en tienda'
            }

            $loaderWrapper.addClass('hide')
  
            $modalContent.html(template).fadeIn()  
    
          } catch(error) {
            console.log(error)
            $loaderWrapper.addClass('hide')
            $modalContent.html('Ocurrió un error, por favor intentalo mas tarde.').fadeIn()  
          }
      }

      function validateSelectedSku(){
        const isSelected = $(' div.product-form__item > div').contents().find( ".selected" ).length

        if (!isSelected) {
          messageErrorBySelectedSku()
        } else {

          if (document.getElementById('message-error-getSku')) {
            $('#message-error-getSku').remove()
          }
        }

        return isSelected
      }

      $('#btn-modal-stock').click(async function(event){
        const $button = $(event.target)
        const $loaderWrapper = $button.find('.loader-wrapper')
        const $modal = $('#modalStock')
        const $modalControls = $modal.find('.controls')
        const $modalContent = $modal.find('#modal-content')
        
        try {
            $loaderWrapper.removeClass('hide')

            $sizesClone = $('.product-template__container .sizes-option-wrapper').clone()
            $sizesClone.find('.unavailable', ':disabled').removeClass('unavailable').prop('disabled', false)
            $modalControls.empty().append($sizesClone)
            $modalContent.fadeOut().empty()

            $modal.find('.size-option-button-wrapper:first .size-option-button').click()

            $('.tbm_modal-container').fadeIn(600);
          	bodyScrollLock.disableBodyScroll()
            $loaderWrapper.addClass('hide')
        } catch(error) {
        	console.log(error)
			bodyScrollLock.enableBodyScroll()
            $loaderWrapper.addClass('hide')
        }
      })

       $('#modalStock .controls').on('click', '.sizes-option-wrapper .size-option-button', async function(e) {
          const $button = $(e.target)
          const $parent = $button.parent().parent()
          const $buttons = $parent.find('.size-option-button') 
          const sku = $button.data('sku')
         
          $buttons.removeClass('selected').prop('disabled', true)
          $button.addClass('selected')

          await checkSkuStock(sku)
          
          $buttons.prop('disabled', false)
       })

      // close modal
      $('.tbm_modal-close, .tbm_modal-clickable').click(function() {
        try {
           	$('.tbm_modal-container').fadeOut(400);
        	bodyScrollLock.enableBodyScroll()
        } catch(error) {
        	console.log(error)
			bodyScrollLock.enableBodyScroll()
        }

      });

      $(document).on('focus', '#stock-prom', function(e) {
        const $parent = $(e.target).closest('.Search-group').addClass('focus')
      })

      $(document).on('blur', '#stock-prom', function(e) {
        const $parent = $(e.target).closest('.Search-group').removeClass('focus')
      })
      
    });
  }, function() { return window.jQuery }) 
</script>